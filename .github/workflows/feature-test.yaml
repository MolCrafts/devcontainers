name: "Test features"
on:
  push:
    branches:
      - master
    paths:
      - 'features/src/**'
      - 'features/test/**'
      - '.github/workflows/feature-test.yaml'
  pull_request:
    paths:
      - 'features/src/**'
      - 'features/test/**'
      - '.github/workflows/feature-test.yaml'
  workflow_dispatch:

concurrency:
  group: feature-test-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-features:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        features:
          - molrs
          - molvis
          - molpy
          - molexp
    steps:
      - uses: actions/checkout@v4

      - name: "Install devcontainer CLI"
        run: npm install -g @devcontainers/cli

      - name: "Test '${{ matrix.features }}'"
        run: devcontainer features test ./features -f ${{ matrix.features }} --base-image mcr.microsoft.com/devcontainers/python:3

  test-molnex-cpu:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: "Install devcontainer CLI"
        run: npm install -g @devcontainers/cli

      - name: "Test molnex global scenarios"
        run: devcontainer features test ./features -f molnex --skip-scenarios --base-image mcr.microsoft.com/devcontainers/python:3

